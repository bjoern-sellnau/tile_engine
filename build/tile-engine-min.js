var setBytes=function(a,b){return a<<18|b};function getBytes(a){return[a&262143,a>>18&262143]}var makeMapTilesArray=function(a,b){for(var d=[],c=a.length;c--;)d[c]=setBytes(a[c],b[c]);return d};var CanvasSupport={canvas_compatible:false,check_canvas:function(){try{CanvasSupport.canvas_compatible=!!document.createElement("canvas").getContext("2d")}catch(a){CanvasSupport.canvas_compatible=!!document.createElement("canvas").getContext}return CanvasSupport.canvas_compatible}};var Console={console:0,hidden:true,init:function(){Console.console=$("<div id='console'>Loading...</br></div>").css("width",$("canvas").css("width")).insertAfter("canvas")},hide:function(){$(Console.console).hide("slow");Console.hidden=true},show:function(){$(Console.console).show("slow");Console.hidden=false},log:function(a){Console.console&&$(Console.console).append("> "+a+"<br />")},error:function(a){Console.console&&$(Console.console).append('> <span style="color:red;">'+a+"</span><br />")}};function newMouse(){var a={down:false,offsetx:0,offsety:0,timer:0,accelx:0,accely:0,clickposx:0,clickposy:0,dx:0,dy:0,view:0,thrust:10,decay:0.97,maxSpeed:200,init:function(b){$(b).mousedown(a.mouseDown).mouseup(function(){a.down=false}).mouseout(function(){a.down=false}).mousemove(a.move);setInterval(a.update,100)},isDown:function(){return a.down},mouseDown:function(b){a.dx=0;a.dy=0;a.setClickPos(b)},setClickPos:function(b){a.clickposx=b.screenX;a.clickposy=b.screenY;a.down=true},move:function(b){a.isDown()?
(a.timer++,a.offsetx=b.screenX-a.clickposx,a.offsety=b.screenY-a.clickposy,a.setClickPos(b),a.accelx=a.offsetx/a.timer,a.accely=a.offsety/a.timer):a.reset()},reset:function(){a.offsetx=0;a.offsety=0;a.accelx=0;a.accely=0;a.timer=0},update:function(){if(a.isDown()){a.dx-=a.accelx*a.thrust;a.dy+=a.accely*a.thrust;var b=Math.sqrt(a.dx*a.dx+a.dy*a.dy);b>a.maxSpeed&&(a.dx*=a.maxSpeed/b,a.dy*=a.maxSpeed/b)}a.dx*=a.decay;a.dy*=a.decay;a.reset()}};return a};function newKeyboard(){var a={orientation:{},LEFT:37,RIGHT:39,UP:38,DOWN:40,thrust:10,maxSpeed:100,key_down:false,_focus:false,ctx_click:false,doc_click:false,dx:0,dy:0,decay:0.97,init:function(b){$(document).keydown(function(b){a.keydown(b)}).keyup(function(b){a.keyup(b)});$(b).mouseup(function(){a.ctx_click=true});$(document).keydown(a.keydown).keyup(a.keyup).mousedown(function(){a.doc_click=true}).mouseup(function(){a._focus=a.ctx_click&&a.doc_click;a.doc_click=a.ctx_click=false});setInterval(a.update,
1)},keydown:function(b){a.orientation[b.keyCode]=a._focus;a.key_down=a._focus},keyup:function(b){a.orientation[b.keyCode]=false;a.key_down=false},update:function(){a.orientation[a.LEFT]&&(a.dx-=a.thrust);a.orientation[a.RIGHT]&&(a.dx+=a.thrust);a.orientation[a.UP]&&(a.dy+=a.thrust);a.orientation[a.DOWN]&&(a.dy-=a.thrust);var b=Math.sqrt(a.dx*a.dx+a.dy*a.dy);b>a.maxSpeed&&(a.dx*=a.maxSpeed/b,a.dy*=a.maxSpeed/b);a.dx*=a.decay;a.dy*=a.decay}};return a};function newZone(){var a={base_canvas:0,dec_canvas:0,tileEngine:0,base_ctx:0,dec_ctx:0,left:0,top:0,right:0,bottom:0,tileWidth:0,tileHeight:0,width:0,height:0,x:0,y:0,viewoffset:0,tiles:0,init:function(b,d,c,e,g,f,h){a.tileEngine=b;a.left=a.x=d;a.top=a.y=c;a.right=d+f;a.bottom=c+h;a.tileWidth=e;a.tileHeight=g;a.width=f;a.height=h;a.base_canvas=document.createElement("canvas");a.base_ctx=a.base_canvas.getContext("2d");a.dec_canvas=document.createElement("canvas");a.dec_ctx=a.dec_canvas.getContext("2d");
a.base_canvas.setAttribute("width",f);a.base_canvas.setAttribute("height",h);a.dec_canvas.setAttribute("width",f);a.dec_canvas.setAttribute("height",h);a.tiles=[]},addTile:function(b){a.tiles.push(b)},arrangeTiles:function(b){for(var d=a.width/a.tileWidth,c=a.height/a.tileHeight,e=0,g=0;g<c;g++)for(var f=0;f<d;f++){var h=f*a.tileWidth+a.x,i=g*a.tileHeight+a.y;a.tiles[e].x=h;a.tiles[e].y=i;a.tiles[e].local_x=f*a.tileWidth;a.tiles[e].local_y=g*a.tileHeight;b[h]||(b[h]=[]);b[h][i]=a.tiles[e];e++}},drawTiles:function(b){a.base_ctx.clearRect(0,
0,a.width,a.height);if(a.tiles)for(var d=a.tiles.length;d--;){var c=a.tiles[d];b.isInView(c)&&a.tileEngine.tileSource[c.baseSourceIndex]&&a.base_ctx.drawImage(a.tileEngine.tileSource[c.baseSourceIndex].canvas,c.local_x,c.local_y);if(c.darker!=0)a.base_ctx.fillStyle="rgba(0,0,0,"+c.darker+")",a.base_ctx.fillRect(c.local_x,c.local_y,a.tileWidth,a.tileHeight),c.darker=0}},forDecoration:function(b){var d=$.extend({},a);d.viewoffset=b;return d},drawDecorations:function(b){a.dec_ctx.clearRect(0,0,a.width,
a.height);if(a.tiles)for(var d=a.tiles.length;d--;){var c=a.tiles[d];c.decorationIndex!=0&&b.isInView(c)&&a.tileEngine.tileSource[c.decorationIndex]&&a.dec_ctx.drawImage(a.tileEngine.tileSource[c.decorationIndex].canvas,c.local_x,c.local_y)}}};return a};function newTile(){var a={x:0,y:0,local_x:0,local_y:0,width:0,height:0,baseSourceIndex:0,decorationIndex:0,physicsID:0,darker:0,init:function(b,d,c,e,g,f){a.x=b;a.y=d;a.width=c;a.height=e;b=getBytes(g);a.baseSourceIndex=b[1];a.decorationIndex=b[0];a.physicsID=f||0}};return a};function newSprite(a,b,d){var c={sourceHash:0,current_index:0,current_direction:0,director:null,init:function(a,b,d,h,i,j){c.director=j;c.sourceHash=i;c.current_direction=c.sourceHash.up;setInterval(c.update_index,100)},update:function(){if(c.dx>1)c.current_direction=c.sourceHash.right;if(c.dx<-1)c.current_direction=c.sourceHash.left;if(c.dy>1)c.current_direction=c.sourceHash.up;if(c.dy<-1)c.current_direction=c.sourceHash.down},current_frame:function(){return c.current_direction[c.current_index]},
update_index:function(){if(c.dx>1||c.dx<-1||c.dy>1||c.dy<-1)if(c.current_index++,c.current_index>=c.current_direction.length)c.current_index=0},draw:function(a,b){if(b)for(var f=b.length;f--;){var h=b[f];c.spriteSource&&h.isInView(c)&&d.drawImage(c.spriteSource[c.current_frame()].canvas,c.x+h.xoffset-a.x,c.y+h.yoffset-a.y)}else c.spriteSource&&a.isInView(c)&&d.drawImage(c.spriteSource[c.current_frame()].canvas,c.x-a.x,c.y-a.y)}};return c};function newTileSource(){var a={canvas:0,ctx:0,sourceImage:0,init:function(b,d,c,e,g){a.sourceImage=g;a.canvas=document.createElement("canvas");a.ctx=a.canvas.getContext("2d");a.canvas.setAttribute("width",b);a.canvas.setAttribute("height",d);a.ctx.drawImage(a.sourceImage.image,c,e,b,d,0,0,b,d)}};return a};function newSourceImage(){var a={imageFilename:0,image:0,init:function(b){a.imageFilename=b;a.image=new Image;a.image.src=b}};return a};function newView(a,b,d,c,e,g){var f={x:a||0,y:b||0,viewWidth:0,viewHeight:0,director:null,xoffset:0,yoffset:0,isControllingSprite:0,main_sprite:0,init:function(a,b,c){f.director=a;f.main_sprite=b;f.isControllingSprite=c;f.decay=0.97;f.update()},update:function(){f.isControllingSprite()&&(f.x+=(f.main_sprite.x-(f.x+d/2))*0.05,f.y+=(f.main_sprite.y-(f.y+c/2))*0.05);if(f.x+d>e)f.x=e-d;else if(f.x<0)f.x=0;if(f.y+c>g)f.y=g-c;else if(f.y<0)f.y=0;f.viewWidth=f.x+d;f.viewHeight=f.y+c},isInView:function(a){return a.x+
a.width>this.x&&a.x<=this.viewWidth&&a.y+a.height>this.y&&a.y<=this.viewHeight},up:function(){var a=$.extend({},this);if(a.y<0)a.y+=g,a.viewHeight=g,a.yoffset=-g;return a},down:function(){var a=$.extend({},this);if(a.viewHeight>g)a.y=0,a.viewHeight-=g,a.yoffset=g;return a},left:function(){var a=$.extend({},this);if(a.x<0)a.x+=e,a.viewWidth=e,a.xoffset=-e;return a},right:function(){var a=$.extend({},this);if(a.viewWidth>e)a.x=0,a.viewWidth-=e,a.xoffset=e;return a}};return f};function Body(a,b,d,c){return{x:a,y:b,px:a,py:b,dx:0,dy:0,width:d,height:c,decay:0.97,setX:function(a){this.x=this.px=a},setY:function(a){this.y=this.py=a},accelerate:function(a){if(this.director)this.dx=this.director.dx,this.dy=this.director.dy;this.x+=this.dx*a*a;this.y-=this.dy*a*a},inertia:function(){var a=this.x-this.px,b=this.y-this.py;this.px=this.x;this.py=this.y;this.x+=a*this.decay;this.y+=b*this.decay}}};function newPhysicsEngine(){var a={tiles:0,tile_width:0,tile_height:0,bodies:[],collidable_bodies:[],ingnore_collide:false,init:function(b,d,c,e,g){a.tiles=b;a.tile_width=d;a.tile_height=c;a.map_width=e;a.map_height=g},to_unit:function(a,d){return Math.floor(a/d)*d},collide:function(){for(var b=0,d=a.collidable_bodies_length;b<d;b++){var c=a.collidable_bodies[b];if(!c.ingnore_collide)for(var e=b+1;e<d;e++){var g=a.collidable_bodies[e];if(!g.ingnore_collide){var f=c.x-g.x,h=c.y-g.y,i=Math.sqrt(f*f+
h*h),j=c.width+g.width;i<j&&(i=(i-j)/i,c.x-=f*i*0.5,c.y-=h*i*0.5,g.x+=f*i*0.5,g.y+=h*i*0.5)}}}},barrier_collide_x:function(b,d,c){var e=b.y+b.height,d=b.dx>0?a.to_unit(d+b.width,a.tile_width):d;do if(a.tiles[d][c].darker=0.4,a.tiles[d][c].physicsID!=0)return b.setX(b.dx>=0?d-a.tile_width:d+a.tile_width),true;while((c+=a.tile_height)<e);return false},barrier_collide_y:function(b,d,c){var e=b.x+b.width,c=b.dy<0?a.to_unit(c+b.height,a.tile_height):c;do if(a.tiles[d][c].darker=0.4,a.tiles[d][c].physicsID!=
0)return b.setY(b.dy>=0?c+a.tile_height:c-a.tile_height),true;while((d+=a.tile_width)<e);return false},barrier_collide:function(){for(var b=a.collidable_bodies_length;b--;){var d=a.collidable_bodies[b],c=a.to_unit(d.x,a.tile_width),e=a.to_unit(d.y,a.tile_height);Math.abs(d.dx)>Math.abs(d.dy)?(a.barrier_collide_x(d,c,e),a.barrier_collide_y(d,c,e)):(a.barrier_collide_y(d,c,e),a.barrier_collide_x(d,c,e))}},border_collide:function(){for(var b=a.collidable_bodies_length;b--;){var d=a.collidable_bodies[b],
c=d.width,e=d.height,g=d.x,f=d.y;if(g<0)d.x=0;else if(g+c>a.map_width)d.x=a.map_width-(c+0.01);if(f<0)d.y=0;else if(f+e>a.map_height)d.y=a.map_height-(e+0.01)}},gravity:function(){for(var b=a.bodies_length;b--;)a.bodies[b].dx*=a.bodies[b].decay,a.bodies[b].dy*=a.bodies[b].decay},accelerate:function(b){for(var d=a.bodies_length;d--;)a.bodies[d].accelerate(b)},inertia:function(b){for(var d=a.bodies_length;d--;)a.bodies[d].inertia(b)},update:function(){for(var b=a.bodies_length;b--;)a.bodies[b].update&&
a.bodies[b].update()},integrate:function(b){a.gravity();a.accelerate(b);a.collide();a.border_collide();a.barrier_collide(b);a.inertia(b);a.update()},add_actor:function(b,d,c,e,g,f){d=Body(d,c,e,g);$.extend(b,d);a.bodies.push(b);f||a.collidable_bodies.push(b);a.bodies_length=a.bodies.length;a.collidable_bodies_length=a.collidable_bodies.length}};return a};function newTileEngine(){var a={canvas:0,ctx:0,tiles:0,zones:0,tileSource:0,tileSourcesHash:{},width:0,height:0,zoneTilesWide:0,zoneTilesHigh:0,tilesHigh:0,tilesWide:0,tileWidth:0,tileHeight:0,mapWidth:0,mapHeight:0,sprites:[],main_sprite:0,mouse:newMouse(),keyboard:newKeyboard(),physics_engine:newPhysicsEngine(),timeofDay:0.2,view:0,active_controller:0,t:0,dt:0.01,currentTime:(new Date).getTime(),accumulator:0,gameTimer:0,fps:250,fps_count:0,fps_timer:0,init:function(){a.view||alert("please set map attributes before initializing tile engine");
a.mouse.init(a.canvas);a.keyboard.init(a.canvas);a.physics_engine.init(a.tiles,a.tileWidth,a.tileHeight,a.mapWidth,a.mapHeight);a.view.init(a.mouse,a.main_sprite,a.isKeyBoardActive);$(a.canvas).mouseup(function(){a.ctx_click=true});$(document).keydown(function(){if(a._focus)a.active_controller=a.keyboard}).mousedown(function(){a.active_controller=a.mouse;a.doc_click=true}).mouseup(function(){a._focus=a.ctx_click&&a.doc_click;a.doc_click=a.ctx_click=false});Console.log("Tile Map Initialized")},start:function(){Console.log("FPS limit set to: "+
a.fps);a.gameTimer=setInterval(a.drawFrame,1E3/a.fps);a.fps_timer=setInterval(a.updateFPS,2E3)},updateFPS:function(){a.fps=a.fps_count/2;a.fps_count=0},isKeyBoardActive:function(){return a.active_controller==a.keyboard},isMouseActive:function(){return a.active_controller==a.mouse},setMapAttributes:function(b){a.canvas=b.canvas;a.ctx=b.ctx;a.width=a.canvas.width;a.height=a.canvas.height;a.tileWidth=b.tileWidth;a.tileHeight=b.tileHeight;a.zoneTilesWide=b.zoneTilesWide;a.zoneTilesHigh=b.zoneTilesHigh;
a.tilesWide=b.tilesWide;a.tilesHigh=b.tilesHigh;a.mapWidth=a.tilesWide*a.tileWidth;a.mapHeight=a.tilesHigh*a.tileHeight;a.view=newView(b.init_x,b.init_y,a.width,a.height,a.mapWidth,a.mapHeight);a.physics_engine.add_actor(a.view,b.init_x,b.init_y,a.width,a.height,true);Console.log(b.sourceTileCounts+" Source Tiles to Load");Console.log(b.tilesArray.length+" Map Tiles to Load");var d=newSourceImage();d.init(b.sourceFile);d.image.onload=function(){a.tileSource=a.createTileSource(b.tileWidth,b.tileHeight,
b.sourceTileCounts,b.sourceTileAccross,b.tile_offset_x||0,b.tile_offset_y||0,d)};a.createTiles(b.tilesArray,b.physicsArray)},setMainSpriteAttributes:function(b){a.main_sprite=a.addSprite(b,a.keyboard)},addSprite:function(b,d){var c=newSprite(a.mapWidth,a.mapHeight,a.ctx);c.init(b.init_x,b.init_y,b.width,b.height,b.movement_hash,d);a.physics_engine.add_actor(c,b.init_x,b.init_y,b.width,b.height);var e=newSourceImage();e.init(b.sourceFile);e.image.onload=function(){c.spriteSource=a.createTileSource(b.width,
b.height,b.sourceTileCounts,b.sourceTileAccross,b.tile_offset_x||0,b.tile_offset_y||0,e)};a.sprites.push(c);return c},integrator:function(){var b=(new Date).getTime(),d=(b-a.currentTime)/100;d>0.25&&(d=0.25);a.currentTime=b;for(a.accumulator+=d;a.accumulator>=a.dt;)a.accumulator-=a.dt,a.physics_engine.integrate(a.dt),a.t+=a.dt;a.active_controller?a.active_controller.update():a.view.update()},drawFrame:function(){a.integrator();a.ctx.clearRect(0,0,a.width,a.height);a.render(a.view);a.fps_count++},
render:function(b){for(var d=a.zones.length,c=[];d--;){var e=a.zones[d];b.isInView(e)&&(c.push(e.forDecoration(b)),e.drawTiles(b),a.ctx.drawImage(e.base_canvas,Math.round(e.x-b.x),Math.round(e.y-b.y)))}for(d=a.sprites.length;d--;)a.sprites[d].draw(b);for(d=c.length;d--;)e=c[d],e.drawDecorations(b),a.ctx.drawImage(e.dec_canvas,e.x-b.x,e.y-b.y);a.ctx.fillStyle="rgba(0, 0, 0,"+a.timeofDay+")";a.ctx.fillRect(0,0,a.width,a.height)},createTileSource:function(b,d,c,e,g,f,h){if(a.tileSourcesHash[h.imageFilename])return a.tileSourcesHash[h.imageFilename];
for(var i=[],j=0,l=0,k=0,m=0,n=0,o=0;o<c;o++){var p=newTileSource();p.init(b,d,l+g*m,k+f*n,h);i.push(p);j++;l+=b;m++;j>=e&&(j=0,k+=d,l=0,n++,m=0)}a.tileSourcesHash[h.imageFilename]=i;return a.tileSourcesHash[h.imageFilename]},createTiles:function(b,d){a.createZones();for(var c=0,e=0,g=0,g=0,f=Math.ceil(a.tilesWide/a.zoneTilesWide),h=0,i=a.tilesHigh;h<i;h++)for(var e=Math.floor(h/a.zoneTilesHigh),j=0,l=a.tilesWide;j<l;j++){var g=Math.floor(j/a.zoneTilesWide),k=newTile();k.init(0,0,a.tileWidth,a.tileHeight,
b[c],d[c]);g=e*f+g;a.zones[g].addTile(k);c++}a.tiles=[];c=0;for(e=a.zones.length;c<e;c++)a.zones[c].arrangeTiles(a.tiles);Console.log("Tiles Ready")},createZones:function(){a.zones=[];for(var b=Math.ceil(a.tilesWide/a.zoneTilesWide),d=Math.ceil(a.tilesHigh/a.zoneTilesHigh),c=a.tilesWide%a.zoneTilesWide,e=a.tilesHigh%a.zoneTilesHigh,g=0;g<d;g++)for(var f=0;f<b;f++){var h=newZone(),i=f*a.zoneTilesWide*a.tileWidth,j=g*a.zoneTilesHigh*a.tileHeight,l=a.zoneTilesWide*a.tileWidth,k=a.zoneTilesWide;f==b-
1&&c>0&&(k=c,l=k*a.tileWidth);var k=a.zoneTilesHigh*a.tileHeight,m=a.zoneTilesHigh;g==d-1&&e>0&&(m=e,k=m*a.tileHeight);h.init(a,i,j,a.tileWidth,a.tileHeight,l,k);a.zones.push(h)}}};Console.init();return CanvasSupport.check_canvas()?a:(Console.log("Your Browser Does not support this app!"),false)};
